# v1.7 Production Deployment Guide

**Complete deployment instructions for theitapprentice.com VPS**
**Estimated Time:** 30-45 minutes

---

## üìã Prerequisites

- SSH access to production VPS
- Git configured with repository access
- Backend running at: `/var/www/fastreactcms/backend`
- Frontend running at: `/var/www/fastreactcms/frontend`
- PostgreSQL database running
- Nginx configured

---

## Part 1: Pre-Deployment Checklist (5 min)

### 1.1 Backup Current Production

```bash
# SSH into production
ssh your-user@theitapprentice.com

# Create backup directory
mkdir -p ~/backups/pre-v1.7-$(date +%Y%m%d)

# Backup database
cd ~/backups/pre-v1.7-$(date +%Y%m%d)
sudo -u postgres pg_dump blogcms_db > database_backup.sql

# Backup current code
cp -r /var/www/fastreactcms ~/backups/pre-v1.7-$(date +%Y%m%d)/fastreactcms

# Verify backups
ls -lh
```

**Expected output:**
```
database_backup.sql    (XX MB)
fastreactcms/         (directory)
```

### 1.2 Check Current Git Status

```bash
cd /var/www/fastreactcms

# Check current branch and commit
git status
git log -1 --oneline

# Check for uncommitted changes
git diff
```

**If uncommitted changes exist:**
```bash
# Stash changes
git stash save "pre-v1.7-deployment"

# Or commit them
git add -A
git commit -m "Pre-v1.7 deployment checkpoint"
```

---

## Part 2: Pull v1.7 Code (5 min)

### 2.1 Fetch Latest Code

```bash
cd /var/www/fastreactcms

# Fetch all branches
git fetch origin

# View commit you're deploying
git log origin/master -5 --oneline
```

**Look for v1.7 commit:**
```
701791d feat: v1.7 - Six Major Features (200% Goal Achievement)
```

### 2.2 Pull v1.7 Changes

```bash
# Pull latest code
git pull origin master

# Verify v1.7 commit is checked out
git log -1 --grep="v1.7"
```

**Expected output:**
```
commit 701791d69af853b406be02dccf67682c908d8572
Author: Andy <andynaisbitt@gmail.com>
Date:   Sun Jan 11 06:25:55 2026 +0000

    feat: v1.7 - Six Major Features (200% Goal Achievement)
```

### 2.3 Review Changes

```bash
# View files changed
git show --stat 701791d

# View new files created
git show --name-status 701791d | grep "^A"
```

**Expected new files:**
```
backend/app/api/v1/endpoints/admin/users.py
backend/app/auth/email_verification.py
backend/app/auth/verification_routes.py
backend/app/services/email_service.py
frontend/src/components/auth/GoogleOAuthButton.tsx
frontend/src/pages/Register.tsx
frontend/src/pages/VerifyEmail.tsx
frontend/src/pages/admin/UserManagement.tsx
```

---

## Part 3: Database Migration (10 min)

### 3.1 Check Current Database Schema

```bash
cd /var/www/fastreactcms/backend

# Check existing migrations
ls -la alembic/versions/*.py | tail -5

# Check current database revision
alembic current
```

### 3.2 Create v1.7 Migration

```bash
# Generate migration for new models
alembic revision --autogenerate -m "v1.7_add_oauth_and_email_verification"
```

**Expected output:**
```
Generating /var/www/fastreactcms/backend/alembic/versions/xxxx_v1.7_add_oauth_and_email_verification.py
```

### 3.3 Review Migration Script

```bash
# Find the newest migration file
MIGRATION_FILE=$(ls -t alembic/versions/*.py | head -1)

# View migration
cat $MIGRATION_FILE
```

**Expected changes:**
1. Add `email_verifications` table
2. Add `google_id` column to `users` table (if not exists)
3. Add `email_verified_at` column to `users` table (if not exists)

**If migration looks incorrect:**
```bash
# Delete bad migration
rm $MIGRATION_FILE

# Manually create migration (see Part 3.4)
```

### 3.4 Manual Migration (If Autogenerate Fails)

```bash
# Create migration manually
alembic revision -m "v1.7_add_oauth_and_email_verification"
```

**Copy this migration script:**

```python
"""v1.7 add oauth and email verification

Revision ID: xxxxx
Revises: xxxxx
Create Date: 2026-01-11

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers
revision = 'xxxxx'  # Will be auto-filled
down_revision = 'xxxxx'  # Will be auto-filled
branch_labels = None
depends_on = None


def upgrade():
    # Create email_verifications table
    op.create_table(
        'email_verifications',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('user_id', sa.Integer(), nullable=False),
        sa.Column('short_code', sa.String(length=6), nullable=False),
        sa.Column('long_token', sa.String(length=64), nullable=False),
        sa.Column('created_at', sa.DateTime(), nullable=False),
        sa.Column('expires_at', sa.DateTime(), nullable=False),
        sa.Column('verified_at', sa.DateTime(), nullable=True),
        sa.Column('is_used', sa.Boolean(), nullable=False, server_default='false'),
        sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
        sa.PrimaryKeyConstraint('id')
    )
    op.create_index('ix_email_verifications_short_code', 'email_verifications', ['short_code'])
    op.create_index('ix_email_verifications_long_token', 'email_verifications', ['long_token'], unique=True)
    op.create_index('ix_email_verifications_user_id', 'email_verifications', ['user_id'])

    # Add google_id to users table (if not exists)
    # This uses try/except in case column already exists
    try:
        op.add_column('users', sa.Column('google_id', sa.String(length=255), nullable=True))
        op.create_index('ix_users_google_id', 'users', ['google_id'], unique=True)
    except Exception:
        pass  # Column already exists

    # Add email_verified_at to users table (if not exists)
    try:
        op.add_column('users', sa.Column('email_verified_at', sa.DateTime(timezone=True), nullable=True))
    except Exception:
        pass  # Column already exists


def downgrade():
    # Drop email_verifications table
    op.drop_index('ix_email_verifications_user_id', table_name='email_verifications')
    op.drop_index('ix_email_verifications_long_token', table_name='email_verifications')
    op.drop_index('ix_email_verifications_short_code', table_name='email_verifications')
    op.drop_table('email_verifications')

    # Drop columns from users table
    try:
        op.drop_index('ix_users_google_id', table_name='users')
        op.drop_column('users', 'google_id')
    except Exception:
        pass

    try:
        op.drop_column('users', 'email_verified_at')
    except Exception:
        pass
```

### 3.5 Run Migration

```bash
# Check migration plan (dry run)
alembic upgrade head --sql

# If looks good, run migration
alembic upgrade head
```

**Expected output:**
```
INFO  [alembic.runtime.migration] Running upgrade xxxxx -> xxxxx, v1.7 add oauth and email verification
```

### 3.6 Verify Migration Success

```bash
# Check current revision
alembic current

# Check database tables
psql -U blogcms_user -d blogcms_db -c "\dt" | grep email_verifications

# Check users table columns
psql -U blogcms_user -d blogcms_db -c "\d users" | grep -E "google_id|email_verified_at"
```

**Expected output:**
```
email_verifications table exists
google_id column exists
email_verified_at column exists
```

---

## Part 4: Backend Deployment (5 min)

### 4.1 Install New Backend Dependencies

```bash
cd /var/www/fastreactcms/backend

# Check if any new dependencies
pip list | grep -E "sendgrid|google"

# If missing, install
pip install -r requirements.txt
```

### 4.2 Configure Environment Variables

```bash
# Edit backend .env
sudo nano .env
```

**Add these new variables (leave empty for now, will configure later):**
```env
# ============================================================================
# GOOGLE OAUTH CONFIGURATION (v1.7) - OPTIONAL
# ============================================================================
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
GOOGLE_REDIRECT_URI=https://theitapprentice.com/login

# ============================================================================
# EMAIL SERVICE CONFIGURATION (v1.7) - REQUIRED FOR EMAIL VERIFICATION
# ============================================================================
# Option 1: SendGrid (recommended)
SENDGRID_API_KEY=

# Option 2: SMTP (alternative)
# SMTP_HOST=smtp.gmail.com
# SMTP_PORT=587
# SMTP_USER=
# SMTP_PASSWORD=
# SMTP_USE_TLS=True

# Email sender details
EMAIL_FROM=noreply@theitapprentice.com
EMAIL_FROM_NAME=The IT Apprentice

# Frontend URL (for verification links)
FRONTEND_URL=https://theitapprentice.com
```

**Save and exit:** Ctrl+X, Y, Enter

### 4.3 Restart Backend Service

```bash
# Restart FastAPI backend
sudo systemctl restart fastreactcms

# Check status
sudo systemctl status fastreactcms

# Check logs for errors
sudo journalctl -u fastreactcms -n 50 --no-pager
```

**Expected output:**
```
‚óè fastreactcms.service - BlogCMS Backend
     Active: active (running) since ...
```

**Check for v1.7 routes:**
```bash
# Test new endpoints
curl -s http://localhost:8100/docs | grep -o "oauth\|verification\|admin/users"
```

---

## Part 5: Frontend Deployment (10 min)

### 5.1 Install New Frontend Dependencies

```bash
cd /var/www/fastreactcms/frontend

# Install new OAuth dependencies
npm install
```

**Expected output:**
```
added 2 packages (@react-oauth/google, jwt-decode)
```

### 5.2 Configure Frontend Environment

```bash
# Edit frontend .env
sudo nano .env
```

**Add these variables:**
```env
# ============================================================================
# GOOGLE OAUTH CONFIGURATION (v1.7) - OPTIONAL
# ============================================================================
# Leave empty until you configure Google OAuth
VITE_GOOGLE_CLIENT_ID=

# ============================================================================
# BACKEND API CONFIGURATION
# ============================================================================
VITE_API_URL=https://theitapprentice.com

# ============================================================================
# APP CONFIGURATION
# ============================================================================
VITE_APP_NAME=The IT Apprentice
VITE_ENV=production
```

**Save and exit:** Ctrl+X, Y, Enter

### 5.3 Build Frontend for Production

```bash
# Clean old build
rm -rf dist

# Build with new code
npm run build
```

**Expected output:**
```
vite v7.3.1 building for production...
‚úì 1234 modules transformed.
dist/index.html                  4.12 kB
dist/assets/index-xxxxx.js     834.23 kB ‚îÇ gzip: 245.12 kB
```

**Verify new pages built:**
```bash
ls -lh dist/assets/ | head -5

# Check dist/index.html includes new routes
grep -o "Register\|VerifyEmail\|UserManagement" dist/assets/*.js | wc -l
```

**Expected:** Should find references to new pages

### 5.4 Restart Frontend Service

```bash
# Restart SSR service (if using)
sudo systemctl restart fastreactcms-ssr

# Check status
sudo systemctl status fastreactcms-ssr

# Restart Nginx
sudo systemctl restart nginx
```

---

## Part 6: Post-Deployment Verification (5 min)

### 6.1 Check Website is Up

```bash
# Test main page
curl -s https://theitapprentice.com | grep -o "<title>.*</title>"

# Test new pages
curl -s https://theitapprentice.com/register -I | grep "200"
curl -s https://theitapprentice.com/verify-email -I | grep "200"
curl -s https://theitapprentice.com/login | grep -o "Google"
```

### 6.2 Test Backend Endpoints

```bash
# Test health
curl -s https://theitapprentice.com/api/v1/health

# Test OAuth endpoint exists
curl -s https://theitapprentice.com/docs | grep "oauth"

# Test verification endpoint exists
curl -s https://theitapprentice.com/docs | grep "verification"

# Test admin users endpoint exists
curl -s https://theitapprentice.com/docs | grep "admin/users"
```

### 6.3 Browser Testing

**Open browser and test:**

1. **Homepage:** https://theitapprentice.com
   - [x] Loads correctly
   - [x] Featured carousel animates smoothly
   - [x] No console errors

2. **Blog List:** https://theitapprentice.com/blog?category=tech-industry
   - [x] Filters by category
   - [x] Shows correct posts

3. **Login Page:** https://theitapprentice.com/login
   - [x] Form displays
   - [x] Google button present (may be placeholder until OAuth configured)
   - [x] "Forgot password" link works

4. **Register Page:** https://theitapprentice.com/register
   - [x] Form displays
   - [x] Password strength indicator works
   - [x] Google button present
   - [x] Submit redirects to verify-email

5. **Verify Email:** https://theitapprentice.com/verify-email
   - [x] Page loads
   - [x] Code input field present
   - [x] Resend email button present

6. **Admin Pages** (login required):
   - [x] /admin - Dashboard loads
   - [x] /admin/users - User management page loads

### 6.4 Check Logs

```bash
# Backend logs (last 100 lines)
sudo journalctl -u fastreactcms -n 100 --no-pager

# Frontend SSR logs
sudo journalctl -u fastreactcms-ssr -n 100 --no-pager

# Nginx error logs
sudo tail -50 /var/log/nginx/error.log

# Look for any errors
sudo journalctl -u fastreactcms -n 100 | grep -i "error\|fail\|exception"
```

**Expected:** No critical errors

---

## Part 7: Optional - Configure OAuth & Email (Later)

### Google OAuth Setup
See: `docs/GOOGLE_OAUTH_PRODUCTION_SETUP.md`

**Steps:**
1. Create Google Cloud project
2. Configure OAuth consent screen
3. Create OAuth client ID
4. Add credentials to `.env` files
5. Rebuild frontend
6. Restart services

### Email Service Setup
See: `docs/GOOGLE_OAUTH_PRODUCTION_SETUP.md` (Step 4)

**Option A: SendGrid**
1. Create SendGrid account
2. Get API key
3. Add to backend `.env`
4. Restart backend

**Option B: SMTP**
1. Get SMTP credentials (Gmail App Password)
2. Add to backend `.env`
3. Restart backend

---

## Part 8: Rollback Plan (If Needed)

**If v1.7 deployment fails:**

### 8.1 Restore Code

```bash
cd /var/www/fastreactcms

# View recent commits
git log -5 --oneline

# Rollback to previous commit (before v1.7)
git reset --hard 1f90684  # Use commit hash before v1.7

# Force pull if needed
git fetch origin
git reset --hard origin/master~1
```

### 8.2 Rollback Database

```bash
# Downgrade one migration
cd /var/www/fastreactcms/backend
alembic downgrade -1

# Or restore from backup
cd ~/backups/pre-v1.7-YYYYMMDD
sudo -u postgres psql blogcms_db < database_backup.sql
```

### 8.3 Rebuild and Restart

```bash
# Rebuild frontend
cd /var/www/fastreactcms/frontend
npm run build

# Restart services
sudo systemctl restart fastreactcms
sudo systemctl restart fastreactcms-ssr
sudo systemctl restart nginx
```

---

## Troubleshooting

### Frontend Build Fails

**Error:** `Module not found: @react-oauth/google`

**Fix:**
```bash
cd /var/www/fastreactcms/frontend
npm install @react-oauth/google jwt-decode
npm run build
```

### Migration Fails: "column already exists"

**Error:** `column "google_id" of relation "users" already exists`

**Fix:** Migration already partially applied. Check and fix:
```bash
# Check what exists
psql -U blogcms_user -d blogcms_db -c "\d users"

# If google_id exists, modify migration to skip it
# Or manually complete migration:
psql -U blogcms_user -d blogcms_db
```

```sql
-- Add missing email_verified_at column
ALTER TABLE users ADD COLUMN IF NOT EXISTS email_verified_at TIMESTAMP WITH TIME ZONE;

-- Create email_verifications table if not exists
CREATE TABLE IF NOT EXISTS email_verifications (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    short_code VARCHAR(6) NOT NULL,
    long_token VARCHAR(64) NOT NULL UNIQUE,
    created_at TIMESTAMP NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    verified_at TIMESTAMP,
    is_used BOOLEAN NOT NULL DEFAULT false
);

CREATE INDEX IF NOT EXISTS ix_email_verifications_short_code ON email_verifications(short_code);
CREATE INDEX IF NOT EXISTS ix_email_verifications_long_token ON email_verifications(long_token);
CREATE INDEX IF NOT EXISTS ix_email_verifications_user_id ON email_verifications(user_id);
```

### Backend Won't Start

**Check logs:**
```bash
sudo journalctl -u fastreactcms -n 50 --no-pager
```

**Common issues:**
- Import error (missing dependency)
- Database connection failed
- Port 8100 already in use

**Fix:**
```bash
# Install missing dependencies
cd /var/www/fastreactcms/backend
pip install -r requirements.txt

# Check port
sudo lsof -i :8100

# Restart service
sudo systemctl restart fastreactcms
```

### 404 on New Pages

**Problem:** `/register` or `/verify-email` returns 404

**Fix:** Frontend not rebuilt or SSR cache

```bash
cd /var/www/fastreactcms/frontend

# Rebuild
npm run build

# Clear SSR cache (if using)
sudo systemctl restart fastreactcms-ssr

# Restart Nginx
sudo systemctl restart nginx
```

---

## Post-Deployment Checklist

### Immediate (Required)
- [x] ‚úÖ Database migration successful
- [x] ‚úÖ Backend service running
- [x] ‚úÖ Frontend rebuilt and deployed
- [x] ‚úÖ Homepage loads
- [x] ‚úÖ Login page loads
- [x] ‚úÖ Register page loads
- [x] ‚úÖ No console errors
- [x] ‚úÖ No backend errors in logs

### Soon (Within 24 hours)
- [ ] ‚è≥ Configure Google OAuth (optional)
- [ ] ‚è≥ Configure email service (for verification)
- [ ] ‚è≥ Test full registration flow
- [ ] ‚è≥ Test OAuth login flow
- [ ] ‚è≥ Test admin user management
- [ ] ‚è≥ Monitor for errors

### Later (Within 1 week)
- [ ] ‚è≥ Create admin user via CLI
- [ ] ‚è≥ Test all v1.7 features
- [ ] ‚è≥ Update production documentation
- [ ] ‚è≥ Setup monitoring for OAuth
- [ ] ‚è≥ Configure email templates (branding)

---

## Success Metrics

**v1.7 deployment successful if:**

1. ‚úÖ Website loads (no downtime)
2. ‚úÖ All existing features work (blog, etc.)
3. ‚úÖ New pages accessible (/register, /verify-email, /admin/users)
4. ‚úÖ Database migration complete (no errors)
5. ‚úÖ Backend logs clean (no exceptions)
6. ‚úÖ Frontend builds successfully

**OAuth/Email optional - can configure later!**

---

## Next Steps

After successful deployment:

1. **Configure Google OAuth** (15 min)
   - See: `docs/GOOGLE_OAUTH_PRODUCTION_SETUP.md`

2. **Configure Email Service** (15 min)
   - See: `docs/GOOGLE_OAUTH_PRODUCTION_SETUP.md` (Step 4)

3. **Test v1.7 Features**
   - Register new account
   - Verify email
   - Login with Google
   - Use admin user management

4. **Monitor Production**
   - Watch logs for errors
   - Check user registrations
   - Monitor OAuth usage

---

**üéâ v1.7 Deployment Complete!**

Your production site now has all 6 v1.7 features ready to use.
