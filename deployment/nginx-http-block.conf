# FastReactCMS - NGINX HTTP Block Configuration
#
# IMPORTANT: These directives MUST be placed in /etc/nginx/nginx.conf
# inside the http { } block, BEFORE the include statement for sites-enabled
#
# Installation:
# 1. Edit /etc/nginx/nginx.conf
# 2. Find the http { block
# 3. Add these lines BEFORE: include /etc/nginx/sites-enabled/*;
# 4. Test: sudo nginx -t
# 5. Reload: sudo systemctl reload nginx

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=ssr_limit:10m rate=30r/m;

# Upstream backend
upstream fastapi_backend {
    server 127.0.0.1:8100;
    keepalive 32;
}

# Upstream SSR server (for crawler meta tag injection)
upstream ssr_server {
    server 127.0.0.1:3001;
    keepalive 8;
}

# Crawler detection map
# Sets $is_crawler = 1 for known crawlers/bots, 0 for regular users
map $http_user_agent $is_crawler {
    default 0;

    # Search engine bots
    ~*googlebot 1;
    ~*bingbot 1;
    ~*slurp 1;        # Yahoo
    ~*duckduckbot 1;
    ~*baiduspider 1;
    ~*yandexbot 1;

    # Social media crawlers
    ~*facebookexternalhit 1;
    ~*facebot 1;
    ~*twitterbot 1;
    ~*linkedinbot 1;
    ~*whatsapp 1;
    ~*slackbot 1;
    ~*discordbot 1;
    ~*telegrambot 1;
    ~*pinterestbot 1;
    ~*redditbot 1;
}
