import{c as fe,r as t,j as e,m as l,a3 as me,T as pe,Z as ne,b as ce,S as je,J as oe,U as we,A as de,X as Ne,u as ye,aa as ve,y as ge,g as xe,C as ke,e as Se,ab as Pe,L as Ce,a5 as Re,f as _e}from"./index-9AhYSV_Z.js";import{t as se}from"./typingGameApi-2s0K0Wqv.js";import{L as ue}from"./loader-2-CpwtcwX3.js";import{R as Me}from"./refresh-cw-YFwQ7-EY.js";import{C as he}from"./clock-1VZINaTW.js";import{M as We}from"./minus-B9xMXCLc.js";import{M as Ae}from"./medal-BWfmeHY2.js";import{S as $e}from"./star-DAR9lLy9.js";import{T as Oe}from"./trending-down-pSk1OlXL.js";import{R as Ee}from"./rotate-ccw-CgZrYYAY.js";import{R as Fe}from"./RegistrationPrompt-Bb3FUcaG.js";import"./log-in-CBBp6fCY.js";const Ie=fe("Frown",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M16 16s-1.5-2-4-2-4 2-4 2",key:"epbg0q"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]]),Ve=({onMatchFound:M,onCancel:u})=>{const[f,C]=t.useState(!1),[p,x]=t.useState(null),[y,c]=t.useState(null),[g,h]=t.useState(0),[r,v]=t.useState(null),[o,R]=t.useState(!0),[P,W]=t.useState(!1),[n,b]=t.useState({rounds:3,timePerRound:60,allowBackspace:!0,difficulty:"medium"});t.useEffect(()=>{(async()=>{try{const m=await se.getMyPVPStats();c(m)}catch(m){console.error("Failed to fetch PVP stats:",m)}finally{R(!1)}})()},[]),t.useEffect(()=>{let s;return f&&(s=setInterval(()=>{h(m=>m+1)},1e3)),()=>clearInterval(s)},[f]),t.useEffect(()=>{let s;return p&&p.status==="WAITING"&&(s=setInterval(async()=>{try{const m=await se.getPVPMatch(p.id);(m.status==="IN_PROGRESS"||m.player2_id)&&(x(m),M(m,n))}catch(m){console.error("Failed to poll match status:",m)}},2e3)),()=>clearInterval(s)},[p,M,n]);const A=t.useCallback(async()=>{C(!0),v(null),h(0);try{const s=await se.findPVPMatch({difficulty:n.difficulty});x(s),(s.player2_id||s.status==="IN_PROGRESS")&&M(s,n)}catch(s){v(s instanceof Error?s.message:"Failed to find match"),C(!1)}},[n,M]),G=t.useCallback(async()=>{if(p)try{await se.cancelPVPMatch(p.id)}catch(s){console.error("Failed to cancel match:",s)}C(!1),x(null),h(0),u()},[p,u]),$=s=>{const m=Math.floor(s/60),H=s%60;return`${m}:${H.toString().padStart(2,"0")}`},k=[{value:"easy",label:"Easy",description:"Relaxed pace",color:"from-green-500 to-emerald-600"},{value:"medium",label:"Medium",description:"Balanced challenge",color:"from-blue-500 to-indigo-600"},{value:"hard",label:"Hard",description:"Fast & precise",color:"from-orange-500 to-red-600"},{value:"expert",label:"Expert",description:"For the elite",color:"from-purple-500 to-pink-600"}],L=s=>({Bronze:"text-orange-600",Silver:"text-gray-400",Gold:"text-yellow-500",Platinum:"text-cyan-400",Diamond:"text-blue-400",Master:"text-purple-500",Grandmaster:"text-red-500"})[s]||"text-gray-500";return e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 py-8",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4",children:[e.jsxs(l.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"text-center mb-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-red-500 to-orange-600 rounded-2xl mb-4 shadow-lg",children:e.jsx(me,{className:"w-10 h-10 text-white"})}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white mb-2",children:"PVP Battle Arena"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Challenge other players in real-time typing battles"})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[e.jsx(l.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:.1},className:"space-y-4",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2",children:[e.jsx(pe,{className:"w-5 h-5 text-yellow-500"}),"Your PVP Stats"]}),o?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(ue,{className:"w-6 h-6 animate-spin text-blue-500"})}):y?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-center p-4 bg-gradient-to-br from-gray-100 to-gray-50 dark:from-gray-700 dark:to-gray-800 rounded-lg",children:[e.jsx("div",{className:`text-3xl font-bold ${L(y.rating_tier)}`,children:y.current_rating}),e.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:[y.rating_tier," Rank"]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Peak: ",y.peak_rating]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-center p-3 bg-green-50 dark:bg-green-900/30 rounded-lg",children:[e.jsx("div",{className:"text-xl font-bold text-green-600 dark:text-green-400",children:y.wins}),e.jsx("div",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Wins"})]}),e.jsxs("div",{className:"text-center p-3 bg-red-50 dark:bg-red-900/30 rounded-lg",children:[e.jsx("div",{className:"text-xl font-bold text-red-600 dark:text-red-400",children:y.losses}),e.jsx("div",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Losses"})]}),e.jsxs("div",{className:"text-center p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg",children:[e.jsxs("div",{className:"text-xl font-bold text-blue-600 dark:text-blue-400",children:[(y.win_rate*100).toFixed(0),"%"]}),e.jsx("div",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Win Rate"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg",children:[e.jsx(ne,{className:"w-4 h-4 text-yellow-500"}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-semibold text-gray-900 dark:text-white",children:[y.best_wpm," WPM"]}),e.jsx("div",{className:"text-xs text-gray-500",children:"Best Speed"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg",children:[e.jsx(ce,{className:"w-4 h-4 text-green-500"}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-semibold text-gray-900 dark:text-white",children:[y.avg_accuracy.toFixed(1),"%"]}),e.jsx("div",{className:"text-xs text-gray-500",children:"Avg Accuracy"})]})]})]}),y.current_win_streak>0&&e.jsxs("div",{className:"flex items-center justify-center gap-2 p-2 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg",children:[e.jsx(je,{className:"w-4 h-4 text-yellow-500"}),e.jsxs("span",{className:"text-sm font-medium text-yellow-700 dark:text-yellow-300",children:[y.current_win_streak," Win Streak!"]})]})]}):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(oe,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No PVP matches yet"}),e.jsx("p",{className:"text-sm",children:"Start playing to build your rating!"})]})]})}),e.jsx(l.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},transition:{delay:.2},children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2",children:[e.jsx(we,{className:"w-5 h-5 text-blue-500"}),"Find Match"]}),e.jsx(de,{mode:"wait",children:f?e.jsxs(l.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"text-center py-8",children:[e.jsxs("div",{className:"relative inline-flex items-center justify-center w-24 h-24 mb-6",children:[e.jsx(l.div,{className:"absolute inset-0 rounded-full bg-gradient-to-r from-red-500 to-orange-600 opacity-20",animate:{scale:[1,1.5,1],opacity:[.2,0,.2]},transition:{duration:2,repeat:1/0}}),e.jsx(l.div,{className:"absolute inset-2 rounded-full bg-gradient-to-r from-red-500 to-orange-600 opacity-30",animate:{scale:[1,1.3,1],opacity:[.3,0,.3]},transition:{duration:2,repeat:1/0,delay:.3}}),e.jsx("div",{className:"w-16 h-16 bg-gradient-to-r from-red-500 to-orange-600 rounded-full flex items-center justify-center",children:e.jsx(ue,{className:"w-8 h-8 text-white animate-spin"})})]}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-2",children:"Searching for Opponent..."}),e.jsxs("p",{className:"text-gray-600 dark:text-gray-400 mb-2",children:[n.difficulty.charAt(0).toUpperCase()+n.difficulty.slice(1)," difficulty"]}),e.jsxs("p",{className:"text-xs text-gray-500 mb-4",children:["Best of ",n.rounds," • ",n.timePerRound,"s rounds",!n.allowBackspace&&" • No corrections"]}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-gray-500 mb-6",children:[e.jsx(he,{className:"w-4 h-4"}),e.jsx("span",{children:$(g)})]}),e.jsxs("button",{onClick:G,className:"px-6 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg font-medium hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors flex items-center justify-center gap-2 mx-auto",children:[e.jsx(Ne,{className:"w-4 h-4"}),"Cancel Search"]}),e.jsxs("div",{className:"mt-8 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-left",children:[e.jsx("h4",{className:"font-medium text-gray-900 dark:text-white mb-2",children:"Tips while you wait:"}),e.jsxs("ul",{className:"text-sm text-gray-600 dark:text-gray-400 space-y-1",children:[e.jsx("li",{children:"• Keep your fingers on the home row"}),e.jsx("li",{children:"• Focus on accuracy over speed"}),e.jsx("li",{children:"• Stay calm - rushed typing leads to errors"})]})]})]},"searching"):e.jsxs(l.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Select Difficulty"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:k.map(s=>e.jsxs("button",{onClick:()=>b(m=>({...m,difficulty:s.value})),className:`p-3 rounded-lg border-2 transition-all ${n.difficulty===s.value?"border-blue-500 bg-blue-50 dark:bg-blue-900/30":"border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"}`,children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-white",children:s.label}),e.jsx("div",{className:"text-xs text-gray-500",children:s.description})]},s.value))})]}),e.jsxs("button",{onClick:()=>W(!P),className:"w-full py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white flex items-center justify-center gap-2",children:[e.jsx(Me,{className:`w-4 h-4 transition-transform ${P?"rotate-180":""}`}),P?"Hide":"Show"," Game Settings"]}),e.jsx(de,{children:P&&e.jsx(l.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"overflow-hidden",children:e.jsxs("div",{className:"p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Number of Rounds"}),e.jsx("div",{className:"flex gap-2",children:[1,3,5].map(s=>e.jsxs("button",{onClick:()=>b(m=>({...m,rounds:s})),className:`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${n.rounds===s?"bg-blue-500 text-white":"bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600"}`,children:["Best of ",s]},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Time Per Round"}),e.jsx("div",{className:"flex gap-2",children:[30,60,90].map(s=>e.jsxs("button",{onClick:()=>b(m=>({...m,timePerRound:s})),className:`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${n.timePerRound===s?"bg-blue-500 text-white":"bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600"}`,children:[s,"s"]},s))})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-white text-sm",children:"Allow Corrections"}),e.jsx("div",{className:"text-xs text-gray-500",children:n.allowBackspace?"Players can use backspace to fix mistakes":"No backspace - mistakes are permanent"})]}),e.jsx("button",{onClick:()=>b(s=>({...s,allowBackspace:!s.allowBackspace})),className:`relative w-12 h-6 rounded-full transition-colors ${n.allowBackspace?"bg-green-500":"bg-gray-300 dark:bg-gray-600"}`,children:e.jsx(l.div,{className:"absolute top-1 w-4 h-4 bg-white rounded-full shadow",animate:{left:n.allowBackspace?28:4},transition:{type:"spring",stiffness:500,damping:30}})})]})]})})}),r&&e.jsx("div",{className:"p-3 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-lg text-sm",children:r}),e.jsxs("button",{onClick:A,className:"w-full py-4 bg-gradient-to-r from-red-500 to-orange-600 text-white rounded-xl font-semibold text-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2",children:[e.jsx(me,{className:"w-5 h-5"}),"Find Opponent"]}),e.jsxs("div",{className:"text-center text-sm text-gray-500",children:[e.jsx("p",{children:"You'll be matched with a player of similar skill level"}),e.jsxs("p",{className:"mt-1",children:["Best of ",n.rounds," rounds • ",n.timePerRound,"s per round",!n.allowBackspace&&" • No corrections"]})]})]},"select")})]})})]}),e.jsx(l.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.3},className:"mt-6 text-center",children:e.jsx("button",{onClick:u,className:"text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors",children:"Back to Typing Games"})})]})})};function Te(M){const{isAuthenticated:u}=ye(),[f,C]=t.useState(!1),[p,x]=t.useState(!1),[y,c]=t.useState(null),g=t.useRef(null),h=t.useRef(null),r=t.useRef(null),v=t.useRef(0),o=5,{matchId:R,onMatchJoined:P,onOpponentJoined:W,onOpponentProgress:n,onOpponentReady:b,onRoundStarted:A,onOpponentFinished:G,onRoundEnded:$,onMatchEnded:k,onOpponentDisconnected:L,onOpponentFound:s,onChat:m,onError:H}=M,U=t.useCallback(()=>{h.current&&(clearTimeout(h.current),h.current=null),r.current&&(clearInterval(r.current),r.current=null),g.current&&(g.current.close(),g.current=null)},[]),Y=t.useCallback(()=>{if(!R||!u){c("Missing match ID or not authenticated");return}if(g.current?.readyState===WebSocket.OPEN)return;x(!0),c(null);const E=window.location.protocol==="https:"?"wss:":"ws:",q=window.location.host,B=`${E}//${q}/ws/pvp/${R}`;try{const O=new WebSocket(B);g.current=O,O.onopen=()=>{console.log("[PVP WebSocket] Connected"),C(!0),x(!1),c(null),v.current=0,r.current=setInterval(()=>{O.readyState===WebSocket.OPEN&&O.send(JSON.stringify({type:"ping"}))},3e4)},O.onmessage=F=>{try{const a=JSON.parse(F.data);switch(console.log("[PVP WebSocket] Message:",a.type,a),a.type){case"match_joined":P?.(a);break;case"opponent_joined":W?.(a.opponent_id);break;case"opponent_progress":n?.(a.data);break;case"player_ready":b?.(a.data?.user_id);break;case"round_started":A?.(a);break;case"opponent_finished":G?.(a.data);break;case"round_ended":$?.(a);break;case"match_ended":k?.(a);break;case"opponent_disconnected":L?.(a.opponent_id);break;case"opponent_found":s?.(a);break;case"chat":m?.(a);break;case"error":H?.(a.message),c(a.message);break;case"pong":break;default:console.warn("[PVP WebSocket] Unknown message type:",a.type)}}catch(a){console.error("[PVP WebSocket] Failed to parse message:",a)}},O.onerror=F=>{console.error("[PVP WebSocket] Error:",F),c("WebSocket connection error")},O.onclose=F=>{if(console.log("[PVP WebSocket] Closed:",F.code,F.reason),C(!1),x(!1),r.current&&(clearInterval(r.current),r.current=null),F.code!==1e3&&F.code!==4001&&F.code!==4003&&F.code!==4004)if(v.current<o){const a=Math.min(1e3*Math.pow(2,v.current),1e4);v.current++,console.log(`[PVP WebSocket] Reconnecting in ${a}ms (attempt ${v.current})`),h.current=setTimeout(Y,a)}else c("Connection lost. Please refresh the page.")}}catch(O){console.error("[PVP WebSocket] Failed to create WebSocket:",O),c("Failed to connect to game server"),x(!1)}},[R,u,P,W,n,b,A,G,$,k,L,s,m,H]),_=t.useCallback(E=>{g.current?.readyState===WebSocket.OPEN?g.current.send(JSON.stringify(E)):console.warn("[PVP WebSocket] Cannot send message, not connected")},[]),J=t.useCallback((E,q,B)=>{_({type:"progress",progress:E,words_typed:q,current_wpm:B})},[_]),z=t.useCallback(()=>{_({type:"round_ready"})},[_]),re=t.useCallback((E,q)=>{_({type:"round_complete",wpm:E,accuracy:q})},[_]),Q=t.useCallback(()=>{_({type:"forfeit"})},[_]),Z=t.useCallback(E=>{_({type:"chat",message:E})},[_]),ee=t.useCallback(()=>{_({type:"ping"})},[_]),te=t.useCallback(()=>{U(),C(!1),x(!1)},[U]),ae=t.useCallback(()=>{U(),v.current=0,Y()},[U,Y]);return t.useEffect(()=>(Y(),U),[Y,U]),{isConnected:f,isConnecting:p,error:y,sendProgress:J,sendReady:z,sendRoundComplete:re,sendForfeit:Q,sendChat:Z,sendPing:ee,disconnect:te,reconnect:ae}}const Be=({match:M,roundText:u,timeLimit:f,currentRound:C,totalRounds:p,playerNumber:x,opponentInfo:y,onRoundComplete:c,onForfeit:g,allowBackspace:h=!0})=>{const[r,v]=t.useState(""),[o,R]=t.useState(null),[P,W]=t.useState(f),[n,b]=t.useState(!1),[A,G]=t.useState(0),[$,k]=t.useState(100),[L,s]=t.useState(0),[m,H]=t.useState(0),[U,Y]=t.useState(0),[_,J]=t.useState(!1),[z,re]=t.useState(!1),Q=t.useRef(null),Z=t.useRef(null),{isConnected:ee,error:te,sendProgress:ae,sendRoundComplete:E,sendForfeit:q}=Te({matchId:M.id,onOpponentProgress:i=>{H(i.progress),Y(i.current_wpm)},onOpponentFinished:i=>{J(!0)},onOpponentDisconnected:()=>{re(!0)}}),B=t.useMemo(()=>u?Math.min(100,r.length/u.length*100):0,[r.length,u]),O=t.useCallback(()=>{if(!o||r.length===0)return{wpm:0,accuracy:100};const i=(Date.now()-o)/1e3/60,j=r.split(/\s+/).length,N=Math.round(j/Math.max(i,.01));let w=0;for(let T=0;T<r.length&&T<u.length;T++)r[T]===u[T]&&w++;const V=r.length>0?w/r.length*100:100;return{wpm:N,accuracy:Math.round(V*10)/10}},[o,r,u]);t.useEffect(()=>{const i=O();G(i.wpm),k(i.accuracy)},[O]),t.useEffect(()=>{if(!o||n)return;const i=setInterval(()=>{const j=Math.floor((Date.now()-o)/1e3),N=Math.max(0,f-j);W(N),N===0&&F()},100);return()=>clearInterval(i)},[o,f,n]),t.useEffect(()=>{if(!(!ee||n))return Z.current=setInterval(()=>{const i=r.split(/\s+/).filter(j=>j).length;ae(B,i,A)},500),()=>{Z.current&&clearInterval(Z.current)}},[ee,n,B,A,r,ae]),t.useEffect(()=>{Q.current?.focus()},[]);const F=t.useCallback(()=>{if(n)return;b(!0);const i=O(),j=o?(Date.now()-o)/1e3:f;E(i.wpm,i.accuracy),c(i.wpm,i.accuracy,j)},[n,O,o,f,E,c]),a=i=>{if(n)return;let j=i.target.value;if(!h&&j.length<r.length){i.target.value=r;return}!o&&j.length>0&&R(Date.now());let N=0;for(let w=0;w<j.length&&w<u.length;w++)j[w]!==u[w]&&N++;if(s(N),v(j),j===u){b(!0);const w=O(),V=o?(Date.now()-o)/1e3:0;E(w.wpm,w.accuracy),c(w.wpm,w.accuracy,V)}},d=()=>{q(),g()},I=()=>{const i=u.split(" ");r.split(" ");let j=0;return i.map((N,w)=>{const V=j,T=N.split("").map((D,be)=>{const le=V+be;let ie="text-gray-400 dark:text-gray-500";return le<r.length?r[le]===D?ie="text-green-500 dark:text-green-400":ie="text-red-500 dark:text-red-400 bg-red-100 dark:bg-red-900/30":le===r.length&&(ie="text-gray-900 dark:text-white bg-blue-100 dark:bg-blue-900/50 border-l-2 border-blue-500 animate-pulse"),e.jsx("span",{className:ie,children:D},le)});j+=N.length+1;const K=V+N.length,X=r.length>K,S=r.length>=V&&r.length<=K;return e.jsxs("span",{className:`inline-block mr-2 mb-1 px-1 rounded transition-all duration-200 ${X?"opacity-60 scale-95":S?"bg-blue-50 dark:bg-blue-900/30 scale-105":""}`,children:[T,w<i.length-1&&e.jsx("span",{className:r.length>K?"text-green-500":"text-gray-400",children:" "})]},w)})};return e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 py-6",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4",children:[e.jsxs(l.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 mb-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center",children:e.jsx(oe,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-white",children:"You"}),e.jsxs("div",{className:"text-sm text-gray-500",children:["Player ",x]})]})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Round"}),e.jsxs("div",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:[C," / ",p]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-white text-right",children:y?.username||"Opponent"}),e.jsx("div",{className:"text-sm text-gray-500 text-right",children:z?e.jsx("span",{className:"text-red-500",children:"Disconnected"}):`Rating: ${y?.rating||"???"}`})]}),e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${z?"bg-red-500":"bg-orange-500"}`,children:z?e.jsx(ve,{className:"w-5 h-5 text-white"}):e.jsx(oe,{className:"w-5 h-5 text-white"})})]})]}),te&&e.jsxs("div",{className:"mt-3 p-2 bg-yellow-50 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 rounded-lg text-sm flex items-center gap-2",children:[e.jsx(ge,{className:"w-4 h-4"}),te]})]}),e.jsxs(l.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1},className:"bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 mb-6",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("span",{className:"text-sm font-medium text-blue-600 dark:text-blue-400",children:"You"}),e.jsxs("span",{className:"text-sm text-gray-500",children:[Math.round(B),"%"]})]}),e.jsx("div",{className:"h-3 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden",children:e.jsx(l.div,{className:"h-full bg-gradient-to-r from-blue-500 to-blue-600 rounded-full",initial:{width:0},animate:{width:`${B}%`},transition:{duration:.2}})})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsxs("span",{className:"text-sm font-medium text-orange-600 dark:text-orange-400",children:[y?.username||"Opponent",_&&" (Finished!)"]}),e.jsxs("span",{className:"text-sm text-gray-500",children:[Math.round(m),"%"]})]}),e.jsx("div",{className:"h-3 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden",children:e.jsx(l.div,{className:"h-full bg-gradient-to-r from-orange-500 to-orange-600 rounded-full",initial:{width:0},animate:{width:`${m}%`},transition:{duration:.2}})})]})]}),e.jsxs(l.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.15},className:"grid grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 text-center",children:[e.jsx(he,{className:"w-5 h-5 mx-auto mb-1 text-blue-500"}),e.jsxs("div",{className:`text-2xl font-bold ${P<=10?"text-red-500 animate-pulse":"text-gray-900 dark:text-white"}`,children:[P,"s"]}),e.jsx("div",{className:"text-xs text-gray-500",children:"Time Left"})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 text-center",children:[e.jsx(ne,{className:"w-5 h-5 mx-auto mb-1 text-yellow-500"}),e.jsx("div",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:A}),e.jsx("div",{className:"text-xs text-gray-500",children:"WPM"})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 text-center",children:[e.jsx(ce,{className:"w-5 h-5 mx-auto mb-1 text-green-500"}),e.jsxs("div",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:[$.toFixed(1),"%"]}),e.jsx("div",{className:"text-xs text-gray-500",children:"Accuracy"})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 text-center",children:[e.jsx(ne,{className:"w-5 h-5 mx-auto mb-1 text-orange-500"}),e.jsx("div",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:U}),e.jsx("div",{className:"text-xs text-gray-500",children:"Opponent WPM"})]})]}),e.jsxs(l.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2},className:"bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6",children:[e.jsx("div",{className:"mb-4 sm:mb-6 p-3 sm:p-4 bg-gray-50 dark:bg-gray-900 rounded-lg font-mono text-sm sm:text-base md:text-lg leading-relaxed select-none overflow-y-auto max-h-40 sm:max-h-60",style:{wordBreak:"break-word"},children:I()}),e.jsx("input",{ref:Q,type:"text",value:r,onChange:a,disabled:n,className:`w-full p-4 text-lg font-mono border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${L>0?"border-red-300 dark:border-red-700 bg-red-50 dark:bg-red-900/20":"border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800"} ${n?"opacity-50 cursor-not-allowed":""}`,placeholder:n?"Round complete!":"Start typing...",autoComplete:"off",autoCapitalize:"off",autoCorrect:"off",spellCheck:!1}),!h&&!n&&e.jsxs("div",{className:"mt-2 text-xs text-yellow-600 dark:text-yellow-400 flex items-center gap-1",children:[e.jsx(ge,{className:"w-3 h-3"}),e.jsx("span",{children:"Corrections disabled - mistakes are permanent"})]}),e.jsxs(de,{children:[n&&e.jsx(l.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"mt-4 p-4 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-lg text-center",children:"Round complete! Waiting for results..."}),_&&!n&&e.jsx(l.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"mt-4 p-4 bg-orange-50 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 rounded-lg text-center",children:"Opponent has finished! Keep going!"})]})]}),e.jsx("div",{className:"mt-6 text-center",children:e.jsx("button",{onClick:d,className:"text-red-500 hover:text-red-700 text-sm font-medium",children:"Forfeit Match"})})]})})},De=({result:M,totalRounds:u,playerName:f,opponentName:C,onContinue:p,isLastRound:x})=>{const{roundNumber:y,playerWpm:c,opponentWpm:g,playerAccuracy:h,opponentAccuracy:r,winner:v,currentScore:o}=M,R=v==="player",P=v==="opponent",W=v==="tie";return e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 py-8 flex items-center justify-center",children:e.jsxs(l.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"max-w-2xl w-full mx-4",children:[e.jsxs(l.div,{initial:{y:-20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.1},className:"text-center mb-8",children:[e.jsxs("div",{className:"text-gray-500 dark:text-gray-400 text-sm mb-2",children:["Round ",y," of ",u]}),e.jsx("h1",{className:`text-4xl font-bold ${R?"text-green-500":P?"text-red-500":"text-yellow-500"}`,children:R?"You Won!":P?"You Lost":"Tie!"})]}),e.jsx(l.div,{initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.2,type:"spring",stiffness:200},className:`mx-auto w-24 h-24 rounded-full flex items-center justify-center mb-8 ${R?"bg-gradient-to-br from-green-400 to-green-600":P?"bg-gradient-to-br from-red-400 to-red-600":"bg-gradient-to-br from-yellow-400 to-yellow-600"}`,children:W?e.jsx(We,{className:"w-12 h-12 text-white"}):e.jsx(xe,{className:"w-12 h-12 text-white"})}),e.jsxs(l.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.3},className:"bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden",children:[e.jsx("div",{className:"bg-gradient-to-r from-blue-500 via-purple-500 to-orange-500 p-4",children:e.jsxs("div",{className:"flex justify-between items-center text-white",children:[e.jsxs("div",{className:"text-center flex-1",children:[e.jsx("div",{className:"text-lg font-medium",children:f}),e.jsx("div",{className:"text-sm opacity-80",children:"You"})]}),e.jsx("div",{className:"text-2xl font-bold px-4",children:"VS"}),e.jsxs("div",{className:"text-center flex-1",children:[e.jsx("div",{className:"text-lg font-medium",children:C}),e.jsx("div",{className:"text-sm opacity-80",children:"Opponent"})]})]})}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm text-gray-500",children:[e.jsx(ne,{className:"w-4 h-4"}),"Words Per Minute"]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(l.div,{initial:{x:-20,opacity:0},animate:{x:0,opacity:1},transition:{delay:.4},className:`text-3xl font-bold ${c>g?"text-green-500":c<g?"text-red-500":"text-gray-900 dark:text-white"}`,children:c}),e.jsxs("div",{className:"flex-1 mx-4 h-3 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden flex",children:[e.jsx(l.div,{initial:{width:0},animate:{width:`${c/(c+g)*100}%`},transition:{delay:.5,duration:.5},className:"h-full bg-blue-500"}),e.jsx(l.div,{initial:{width:0},animate:{width:`${g/(c+g)*100}%`},transition:{delay:.5,duration:.5},className:"h-full bg-orange-500"})]}),e.jsx(l.div,{initial:{x:20,opacity:0},animate:{x:0,opacity:1},transition:{delay:.4},className:`text-3xl font-bold ${g>c?"text-green-500":g<c?"text-red-500":"text-gray-900 dark:text-white"}`,children:g})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm text-gray-500",children:[e.jsx(ce,{className:"w-4 h-4"}),"Accuracy"]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(l.div,{initial:{x:-20,opacity:0},animate:{x:0,opacity:1},transition:{delay:.5},className:`text-3xl font-bold ${h>r?"text-green-500":h<r?"text-red-500":"text-gray-900 dark:text-white"}`,children:[h.toFixed(1),"%"]}),e.jsxs("div",{className:"flex-1 mx-4 h-3 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden flex",children:[e.jsx(l.div,{initial:{width:0},animate:{width:`${h}%`},transition:{delay:.6,duration:.5},className:"h-full bg-blue-500",style:{maxWidth:"50%"}}),e.jsx(l.div,{initial:{width:0},animate:{width:`${r}%`},transition:{delay:.6,duration:.5},className:"h-full bg-orange-500",style:{maxWidth:"50%",marginLeft:"auto"}})]}),e.jsxs(l.div,{initial:{x:20,opacity:0},animate:{x:0,opacity:1},transition:{delay:.5},className:`text-3xl font-bold ${r>h?"text-green-500":r<h?"text-red-500":"text-gray-900 dark:text-white"}`,children:[r.toFixed(1),"%"]})]})]})]}),e.jsxs(l.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.7},className:"bg-gray-50 dark:bg-gray-900 p-4",children:[e.jsx("div",{className:"text-center text-sm text-gray-500 mb-2",children:"Match Score"}),e.jsxs("div",{className:"flex justify-center items-center gap-8",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:`text-4xl font-bold ${o.player>o.opponent?"text-green-500":"text-gray-900 dark:text-white"}`,children:o.player}),e.jsx("div",{className:"text-sm text-gray-500",children:f})]}),e.jsx("div",{className:"text-2xl font-bold text-gray-400",children:"-"}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:`text-4xl font-bold ${o.opponent>o.player?"text-green-500":"text-gray-900 dark:text-white"}`,children:o.opponent}),e.jsx("div",{className:"text-sm text-gray-500",children:C})]})]})]})]}),e.jsx(l.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.8},className:"mt-6 text-center",children:e.jsxs("button",{onClick:p,className:"px-8 py-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl font-semibold text-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2 mx-auto",children:[x?"See Final Results":"Next Round",e.jsx(ke,{className:"w-5 h-5"})]})})]})})},Ge=({result:M,playerName:u,opponentName:f,onPlayAgain:C,onBackToLobby:p})=>{const{winner:x,playerScore:y,opponentScore:c,playerTotalWpm:g,opponentTotalWpm:h,playerAvgAccuracy:r,opponentAvgAccuracy:v,xpEarned:o,ratingChange:R,newRating:P,roundResults:W,matchDuration:n}=M,b=x==="player",A=x==="tie",G=$=>{const k=Math.floor($/60),L=$%60;return`${k}m ${L}s`};return e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 py-8",children:e.jsxs("div",{className:"max-w-3xl mx-auto px-4",children:[e.jsxs(l.div,{initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},transition:{type:"spring",stiffness:200,delay:.1},className:"text-center mb-8",children:[e.jsx(l.div,{initial:{y:-50},animate:{y:0},transition:{type:"spring",stiffness:100,delay:.3},className:`inline-flex items-center justify-center w-32 h-32 rounded-full mb-4 ${b?"bg-gradient-to-br from-yellow-400 to-amber-600":A?"bg-gradient-to-br from-gray-400 to-gray-600":"bg-gradient-to-br from-gray-600 to-gray-800"}`,children:b?e.jsx(pe,{className:"w-16 h-16 text-white"}):A?e.jsx(Ae,{className:"w-16 h-16 text-white"}):e.jsx(Ie,{className:"w-16 h-16 text-white"})}),e.jsx(l.h1,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.5},className:`text-5xl font-bold mb-2 ${b?"text-yellow-500":A?"text-gray-500":"text-gray-700 dark:text-gray-300"}`,children:b?"Victory!":A?"Draw!":"Defeat"}),e.jsx(l.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.6},className:"text-gray-600 dark:text-gray-400 text-lg",children:b?"Congratulations on your win!":A?"A close match!":"Better luck next time!"})]}),e.jsxs(l.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.7},className:"bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6",children:[e.jsx("div",{className:"text-center text-sm text-gray-500 mb-4",children:"Final Score"}),e.jsxs("div",{className:"flex justify-center items-center gap-8",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:`text-5xl font-bold ${b?"text-green-500":"text-gray-900 dark:text-white"}`,children:y}),e.jsx("div",{className:"text-gray-600 dark:text-gray-400 mt-1",children:u}),b&&e.jsx(xe,{className:"w-6 h-6 text-yellow-500 mx-auto mt-2"})]}),e.jsx("div",{className:"text-3xl font-bold text-gray-400",children:"-"}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:`text-5xl font-bold ${x==="opponent"?"text-green-500":"text-gray-900 dark:text-white"}`,children:c}),e.jsx("div",{className:"text-gray-600 dark:text-gray-400 mt-1",children:f}),x==="opponent"&&e.jsx(xe,{className:"w-6 h-6 text-yellow-500 mx-auto mt-2"})]})]})]}),e.jsxs(l.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.8},className:"grid grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 text-center",children:[e.jsx($e,{className:"w-8 h-8 mx-auto mb-2 text-yellow-500"}),e.jsxs("div",{className:"text-3xl font-bold text-yellow-500",children:["+",o]}),e.jsx("div",{className:"text-sm text-gray-500",children:"XP Earned"})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 text-center",children:[R>=0?e.jsx(Se,{className:"w-8 h-8 mx-auto mb-2 text-green-500"}):e.jsx(Oe,{className:"w-8 h-8 mx-auto mb-2 text-red-500"}),e.jsxs("div",{className:`text-3xl font-bold ${R>=0?"text-green-500":"text-red-500"}`,children:[R>=0?"+":"",R]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["Rating (",P,")"]})]})]}),e.jsxs(l.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.9},className:"bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4 text-center",children:"Match Statistics"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"w-5 h-5 text-blue-500"}),e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Avg WPM"})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:`font-bold ${g>h?"text-green-500":"text-gray-900 dark:text-white"}`,children:g}),e.jsx("span",{className:"text-gray-400",children:"vs"}),e.jsx("span",{className:`font-bold ${h>g?"text-green-500":"text-gray-900 dark:text-white"}`,children:h})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"w-5 h-5 text-green-500"}),e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Avg Accuracy"})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{className:`font-bold ${r>v?"text-green-500":"text-gray-900 dark:text-white"}`,children:[r.toFixed(1),"%"]}),e.jsx("span",{className:"text-gray-400",children:"vs"}),e.jsxs("span",{className:`font-bold ${v>r?"text-green-500":"text-gray-900 dark:text-white"}`,children:[v.toFixed(1),"%"]})]})]}),e.jsxs("div",{className:"flex items-center justify-between border-t dark:border-gray-700 pt-4",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Match Duration"}),e.jsx("span",{className:"font-bold text-gray-900 dark:text-white",children:G(n)})]})]})]}),e.jsxs(l.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:1},className:"bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4 text-center",children:"Round Breakdown"}),e.jsx("div",{className:"space-y-3",children:W.map(($,k)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${$.winner===(k===0?1:2)?"bg-green-100 dark:bg-green-900/50 text-green-600":$.winner===null?"bg-yellow-100 dark:bg-yellow-900/50 text-yellow-600":"bg-red-100 dark:bg-red-900/50 text-red-600"}`,children:k+1}),e.jsxs("span",{className:"text-gray-900 dark:text-white font-medium",children:["Round ",k+1]})]}),e.jsx("div",{className:"flex items-center gap-4 text-sm",children:e.jsxs("span",{className:"text-gray-600 dark:text-gray-400",children:[$.p1_wpm||0," vs ",$.p2_wpm||0," WPM"]})})]},k))})]}),e.jsxs(l.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:1.1},className:"flex flex-col sm:flex-row gap-4 justify-center",children:[e.jsxs("button",{onClick:C,className:"flex-1 sm:flex-none px-8 py-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl font-semibold text-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2",children:[e.jsx(Ee,{className:"w-5 h-5"}),"Play Again"]}),e.jsxs("button",{onClick:p,className:"flex-1 sm:flex-none px-8 py-4 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-xl font-semibold text-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors flex items-center justify-center gap-2",children:[e.jsx(Pe,{className:"w-5 h-5"}),"Back to Lobby"]})]}),e.jsx(l.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:1.2},className:"mt-6 text-center",children:e.jsxs(Ce,{to:"/games/typing/leaderboard",className:"text-blue-500 hover:text-blue-600 text-sm font-medium flex items-center justify-center gap-1",children:[e.jsx(Re,{className:"w-4 h-4"}),"View Leaderboard"]})})]})})},tt=()=>{const M=_e(),{isAuthenticated:u,user:f}=ye(),[C,p]=t.useState("lobby"),[x,y]=t.useState(null),[c,g]=t.useState(1),[h,r]=t.useState(1),[v,o]=t.useState(""),[R,P]=t.useState(60),[W,n]=t.useState(null),[b,A]=t.useState(null),[G,$]=t.useState(null),[k,L]=t.useState(3),[s,m]=t.useState({rounds:3,timePerRound:60,allowBackspace:!0,difficulty:"medium"}),[H,U]=t.useState(0),[Y,_]=t.useState(0),[J,z]=t.useState([]),[re,Q]=t.useState(!u);t.useEffect(()=>{Q(!u)},[u]);const Z=t.useCallback(()=>{M("/games/typing")},[M]);t.useCallback(a=>{console.log("[PVP] Match joined:",a),g(a.player_number),r(a.current_round)},[]),t.useCallback(a=>{console.log("[PVP] Opponent joined:",a),n({username:`Player ${a}`,rating:1200})},[]),t.useCallback(a=>{console.log("[PVP] Opponent found:",a),n({username:a.opponent.username||"Opponent",rating:a.opponent.rating||1200})},[]),t.useCallback(a=>{console.log("[PVP] Round started:",a),o(a.text_content),P(a.time_limit),L(3),p("countdown")},[]),t.useEffect(()=>{if(C!=="countdown")return;if(k<=0){p("playing");return}const a=setTimeout(()=>{L(d=>d-1)},1e3);return()=>clearTimeout(a)},[C,k]),t.useCallback(a=>{console.log("[PVP] Round ended:",a);const{results:d,round_number:I}=a,i=c===1,j=i?d.player1_wpm:d.player2_wpm,N=i?d.player2_wpm:d.player1_wpm,w=i?d.player1_accuracy:d.player2_accuracy,V=i?d.player2_accuracy:d.player1_accuracy;let T="tie";d.round_winner!==null&&(T=d.round_winner===(i?1:2)?"player":"opponent");const K=T==="player"?H+1:H,X=T==="opponent"?Y+1:Y;U(K),_(X),z(S=>[...S,{playerWpm:j,opponentWpm:N,playerAccuracy:w,opponentAccuracy:V}]),A({roundNumber:I,playerWpm:j,opponentWpm:N,playerAccuracy:w,opponentAccuracy:V,winner:T,currentScore:{player:K,opponent:X}}),p("round_results")},[c,H,Y]),t.useCallback(a=>{console.log("[PVP] Match ended:",a);const{results:d,reason:I,forfeit_by:i}=a,j=c===1,N=J.length||1,w=J.reduce((S,D)=>S+D.playerWpm,0)/N,V=J.reduce((S,D)=>S+D.opponentWpm,0)/N,T=J.reduce((S,D)=>S+D.playerAccuracy,0)/N,K=J.reduce((S,D)=>S+D.opponentAccuracy,0)/N;let X="tie";d.winner_id!==null?X=d.winner_id===f?.id?"player":"opponent":I==="forfeit"&&i&&(X=i===f?.id?"opponent":"player"),$({winner:X,playerScore:j?d.player1_score:d.player2_score,opponentScore:j?d.player2_score:d.player1_score,playerTotalWpm:Math.round(w),opponentTotalWpm:Math.round(V),playerAvgAccuracy:T,opponentAvgAccuracy:K,xpEarned:d.xp_earned||0,ratingChange:d.rating_change||0,newRating:f?.pvp_rating||1200+(d.rating_change||0),roundResults:J.map((S,D)=>({round:D+1,p1_wpm:S.playerWpm,p2_wpm:S.opponentWpm,p1_accuracy:S.playerAccuracy,p2_accuracy:S.opponentAccuracy,winner:S.playerWpm>S.opponentWpm?1:S.opponentWpm>S.playerWpm?2:void 0})),matchDuration:180}),p("match_results")},[c,J,f]),t.useCallback(()=>{console.log("[PVP] Opponent disconnected")},[]),x&&x.id;const ee=t.useCallback(async(a,d)=>{console.log("[PVP] Match found:",a,"with settings:",d),y(a),m(d),P(d.timePerRound),p("waiting");try{const I=await se.getPVPMatch(a.id);y(I),I.status==="IN_PROGRESS"&&I.content&&(o(I.content),p("playing"))}catch(I){console.error("Failed to fetch match details:",I)}},[]),te=t.useCallback(()=>{M("/games/typing")},[M]),ae=t.useCallback(async(a,d,I)=>{if(x)try{const i=Math.round(I),j=Math.min(100,Math.max(0,d)),N=Math.min(300,Math.max(0,a)),w=Math.floor(N*(i/60)),V=await se.submitPVPRound({match_id:x.id,wpm:N,accuracy:j,time_elapsed:i,words_typed:w});console.log("[PVP] Round submitted:",V)}catch(i){console.error("Failed to submit round:",i)}},[x]),E=t.useCallback(()=>{p("match_results")},[]),q=t.useCallback(()=>{if(b&&x){const a=x.total_rounds||3;b.roundNumber>=a?p("match_results"):(r(b.roundNumber+1),o(""),p("waiting"))}},[b,x]),B=t.useCallback(()=>{y(null),g(1),r(1),o(""),U(0),_(0),z([]),A(null),$(null),n(null),p("lobby")},[]),O=t.useCallback(()=>{B()},[B]),F=()=>{switch(C){case"lobby":return e.jsx(Ve,{onMatchFound:ee,onCancel:te});case"waiting":return e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"}),e.jsxs("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-2",children:["Waiting for Round ",h," to Start..."]}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Get ready to type!"})]})});case"countdown":return e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("p",{className:"text-gray-500 dark:text-gray-400 text-lg mb-2",children:["Round ",h]}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Get Ready!"})]}),e.jsxs("div",{className:"relative mb-8",children:[e.jsx("div",{className:"text-9xl font-bold text-blue-500 animate-bounce",style:{animation:"pulse 1s ease-in-out",textShadow:"0 0 40px rgba(59, 130, 246, 0.5)"},children:k>0?k:"GO!"},k),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",style:{pointerEvents:"none"},children:e.jsx("div",{className:"w-32 h-32 rounded-full border-4 border-blue-500 animate-ping opacity-50"},`ripple-${k}`)})]}),W&&e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-4 shadow-lg inline-block",children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:"Opponent"}),e.jsx("p",{className:"text-gray-900 dark:text-white font-semibold",children:W.username}),e.jsxs("p",{className:"text-gray-400 text-xs",children:["Rating: ",W.rating]})]}),e.jsx("p",{className:"mt-8 text-gray-500 dark:text-gray-400 text-sm",children:"Type the text as fast and accurately as possible!"})]})});case"playing":return x?e.jsx(Be,{match:x,roundText:v,timeLimit:R,currentRound:h,totalRounds:s.rounds,playerNumber:c,opponentInfo:W||void 0,onRoundComplete:ae,onForfeit:E,allowBackspace:s.allowBackspace}):null;case"round_results":return b?e.jsx(De,{result:b,totalRounds:s.rounds,playerName:f?.first_name||f?.username||"You",opponentName:W?.username||"Opponent",onContinue:q,isLastRound:b.roundNumber>=s.rounds}):null;case"match_results":return G?e.jsx(Ge,{result:G,playerName:f?.first_name||f?.username||"You",opponentName:W?.username||"Opponent",onPlayAgain:B,onBackToLobby:O}):null;default:return null}};return u?F():e.jsx(Fe,{isOpen:re,onClose:Z,context:"pvp",required:!0})};export{tt as PVPPage,tt as default};
